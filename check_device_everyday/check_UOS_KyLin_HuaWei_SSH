#!/usr/bin/env python3
# -*- coding: utf-8 -*-
#!version:1.1
"""
@è®¾å¤‡çŠ¶æ€å·¡æ£€è„šæœ¬
@åŠŸèƒ½:æ£€æŸ¥éº’éºŸç³»ç»Ÿã€ç»Ÿä¿¡ç³»ç»Ÿã€æœåŠ¡å™¨ã€ç½‘ç»œè®¾å¤‡å’Œæ‰“å°æœºçš„åŸºæœ¬è¿è¡ŒçŠ¶æ€
@ä½œè€…:å·¡æ£€ç³»ç»Ÿ
@æ—¥æœŸ:2026-02-06
@æ”¹è¿›:æ·»åŠ è®¾å¤‡æ’åºã€å¯é…ç½®ä¿å­˜ä½ç½®
"""

import subprocess
import socket
import time
import threading
import os
import argparse
from concurrent.futures import ThreadPoolExecutor, as_completed
from typing import Dict, List, Tuple, Optional
import logging
from datetime import datetime

# é…ç½®æ—¥å¿—
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('device_check.log'),
        logging.StreamHandler()
    ]
)
logger = logging.getLogger(__name__)

class DeviceChecker:
    def __init__(self, output_dir: str = "."):
        """
        åˆå§‹åŒ–è®¾å¤‡æ£€æŸ¥å™¨
        
        Args:
            output_dir: æŠ¥å‘Šä¿å­˜ç›®å½•
        """
        self.output_dir = output_dir
        
        # åˆ›å»ºä¿å­˜ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        if not os.path.exists(output_dir):
            os.makedirs(output_dir)
        
        # è®¾å¤‡åˆ—è¡¨ - è¯·æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹IPåœ°å€å’Œå‡­æ®
        # è®¾å¤‡æŒ‰ç…§ç±»å‹å’Œåºå·ä»ä½åˆ°é«˜æ’åº
        self.devices = {
            # éº’éºŸ/ç»Ÿä¿¡å°å¼æœº (4å°) - æŒ‰åºå·æ’åº
            'desktop1': {'ip': '172.16.11.1', 'type': 'kylin', 'port': 22, 'username': 'admin', 'order': 1},
            'desktop2': {'ip': '172.16.11.2', 'type': 'uos', 'port': 22, 'username': 'admin', 'order': 2},
            'desktop3': {'ip': '172.16.11.3', 'type': 'uos', 'port': 22, 'username': 'admin', 'order': 3},
            'desktop4': {'ip': '172.16.11.4', 'type': 'kylin', 'port': 22, 'username': 'admin', 'order': 4},
            
            # ç¬”è®°æœ¬ç”µè„‘ (2å°) - æŒ‰åºå·æ’åº
            'laptop1': {'ip': '172.16.11.5', 'type': 'uos', 'port': 22, 'username': 'admin', 'order': 5},
            'laptop2': {'ip': '172.16.11.6', 'type': 'uos', 'port': 22, 'username': 'admin', 'order': 6},
            
            # æœåŠ¡å™¨ (4å°) - æŒ‰åºå·æ’åº
            'server1': {'ip': '172.16.12.1', 'type': 'server', 'port': 22, 'username': 'root', 'order': 7},
            'server2': {'ip': '172.16.12.2', 'type': 'server', 'port': 22, 'username': 'root', 'order': 8},
            'server3': {'ip': '172.16.12.3', 'type': 'server', 'port': 22, 'username': 'root', 'order': 9},
            'server4': {'ip': '172.16.12.4', 'type': 'server', 'port': 22, 'username': 'root', 'order': 10},
            
            # å…³é”®ç½‘ç»œè®¾å¤‡ - æŒ‰åºå·æ’åº
            'huawei_switch': {'ip': '172.16.11.254', 'type': 'huawei_switch', 'port': 22, 'order': 11},
            'huawei_firewall': {'ip': '172.16.1.14', 'type': 'huawei_firewall', 'port': 22, 'order': 12},
            
            # æ‰“å°æœº
            'printer': {'ip': '172.16.11.7', 'type': 'printer', 'port': 9100, 'order': 13}
        }
        
        # è®¾å¤‡ç±»å‹æ’åºæ˜ å°„ï¼ˆæ§åˆ¶æœ€ç»ˆæŠ¥å‘Šä¸­è®¾å¤‡ç±»å‹çš„æ˜¾ç¤ºé¡ºåºï¼‰
        self.type_order = {
            'kylin': 1,       # éº’éºŸç³»ç»Ÿ
            'uos': 2,         # ç»Ÿä¿¡ç³»ç»Ÿ
            'server': 3,      # æœåŠ¡å™¨
            'huawei_switch': 4,  # åä¸ºäº¤æ¢æœº
            'huawei_firewall': 5, # åä¸ºé˜²ç«å¢™
            'printer': 6      # æ‰“å°æœº
        }
        
        # é€šç”¨å¯†ç  - å»ºè®®ä½¿ç”¨æ›´å®‰å…¨çš„æ–¹å¼å­˜å‚¨
        self.password = "your_password_here"  # è¯·ä¿®æ”¹ä¸ºå®é™…å¯†ç 
        
    def get_sorted_devices(self) -> List[Tuple[str, Dict]]:
        """
        è·å–æ’åºåçš„è®¾å¤‡åˆ—è¡¨
        
        æ’åºè§„åˆ™:
        1. å…ˆæŒ‰è®¾å¤‡ç±»å‹æ’åº (kylin -> uos -> server -> ç½‘ç»œè®¾å¤‡ -> æ‰“å°æœº)
        2. åŒç±»å‹è®¾å¤‡æŒ‰åºå·æ’åº
        """
        # æå–æ‰€æœ‰è®¾å¤‡å¹¶æ·»åŠ æ’åºé”®
        devices_list = []
        for name, info in self.devices.items():
            device_info = info.copy()
            # æå–è®¾å¤‡åºå·ï¼ˆä»è®¾å¤‡åç§°ä¸­æå–æ•°å­—ï¼‰
            import re
            numbers = re.findall(r'\d+', name)
            device_order = int(numbers[0]) if numbers else float('inf')
            
            # ç±»å‹æ’åºå€¼
            type_order = self.type_order.get(info['type'], 99)
            
            # åˆ›å»ºæ’åºé”®ï¼š(ç±»å‹æ’åº, è®¾å¤‡åºå·, è®¾å¤‡åç§°)
            sort_key = (type_order, device_order, name)
            devices_list.append((sort_key, name, device_info))
        
        # æŒ‰æ’åºé”®æ’åº
        devices_list.sort(key=lambda x: x[0])
        
        # è¿”å›æ’åºåçš„è®¾å¤‡åˆ—è¡¨
        return [(name, info) for _, name, info in devices_list]
    
    def check_port(self, host: str, port: int, timeout: int = 3) -> bool:
        """æ£€æŸ¥ç«¯å£æ˜¯å¦å¼€æ”¾"""
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(timeout)
            result = sock.connect_ex((host, port))
            sock.close()
            return result == 0
        except Exception as e:
            logger.error(f"æ£€æŸ¥ç«¯å£æ—¶å‡ºé”™ {host}:{port}: {e}")
            return False
    
    def ping_host(self, host: str) -> bool:
        """Pingä¸»æœºæ£€æŸ¥è¿é€šæ€§"""
        try:
            # Linux/Mac
            param = '-c' if hasattr(subprocess, 'DEVNULL') else '-n'
            command = ['ping', param, '3', '-W', '2', host]
            
            # Windowsç³»ç»Ÿä½¿ç”¨ä»¥ä¸‹å‘½ä»¤
            # command = ['ping', '-n', '3', '-w', '2000', host]
            
            result = subprocess.run(command, 
                                  stdout=subprocess.DEVNULL, 
                                  stderr=subprocess.DEVNULL)
            return result.returncode == 0
        except Exception as e:
            logger.error(f"Ping {host} æ—¶å‡ºé”™: {e}")
            return False
    
    def check_linux_device(self, device_name: str, device_info: Dict) -> Dict:
        """æ£€æŸ¥Linuxè®¾å¤‡(éº’éºŸ/UOS/æœåŠ¡å™¨)"""
        result = {
            'name': device_name,
            'ip': device_info['ip'],
            'type': device_info['type'],
            'status': 'unknown',
            'response_time': None,
            'details': '',
            'order': device_info.get('order', 999)
        }
        
        start_time = time.time()
        
        # 1. æ£€æŸ¥Pingè¿é€šæ€§
        if not self.ping_host(device_info['ip']):
            result['status'] = 'offline'
            result['details'] = 'æ— æ³•Pingé€šè®¾å¤‡'
            return result
        
        # 2. æ£€æŸ¥SSHç«¯å£
        if not self.check_port(device_info['ip'], device_info['port']):
            result['status'] = 'warning'
            result['details'] = 'è®¾å¤‡åœ¨çº¿ä½†SSHç«¯å£ä¸å¯ç”¨'
            result['response_time'] = time.time() - start_time
            return result
        
        result['status'] = 'online'
        result['response_time'] = time.time() - start_time
        result['details'] = 'è®¾å¤‡è¿è¡Œæ­£å¸¸'
        
        return result
    
    def check_network_device(self, device_name: str, device_info: Dict) -> Dict:
        """æ£€æŸ¥åä¸ºç½‘ç»œè®¾å¤‡ï¼ˆäº¤æ¢æœºã€é˜²ç«å¢™ï¼‰"""
        result = {
            'name': device_name,
            'ip': device_info['ip'],
            'type': device_info['type'],
            'status': 'unknown',
            'response_time': None,
            'details': '',
            'order': device_info.get('order', 999)
        }
        
        start_time = time.time()
        
        # 1. æ£€æŸ¥Pingè¿é€šæ€§
        if not self.ping_host(device_info['ip']):
            result['status'] = 'offline'
            result['details'] = 'æ— æ³•Pingé€šè®¾å¤‡'
            return result
        
        # 2. æ£€æŸ¥SSH/Telnetç«¯å£
        if not self.check_port(device_info['ip'], device_info['port']):
            result['status'] = 'warning'
            result['details'] = 'è®¾å¤‡åœ¨çº¿ä½†ç®¡ç†ç«¯å£ä¸å¯ç”¨'
            result['response_time'] = time.time() - start_time
            return result
        
        result['status'] = 'online'
        result['response_time'] = time.time() - start_time
        result['details'] = 'ç½‘ç»œè®¾å¤‡è¿è¡Œæ­£å¸¸'
        
        return result
    
    def check_printer(self, device_name: str, device_info: Dict) -> Dict:
        """æ£€æŸ¥æ‰“å°æœºçŠ¶æ€"""
        result = {
            'name': device_name,
            'ip': device_info['ip'],
            'type': device_info['type'],
            'status': 'unknown',
            'response_time': None,
            'details': '',
            'order': device_info.get('order', 999)
        }
        
        start_time = time.time()
        
        # 1. æ£€æŸ¥Pingè¿é€šæ€§
        if not self.ping_host(device_info['ip']):
            result['status'] = 'offline'
            result['details'] = 'æ— æ³•Pingé€šæ‰“å°æœº'
            return result
        
        # 2. æ£€æŸ¥æ‰“å°æœºå¸¸ç”¨ç«¯å£
        printer_ports = [9100, 515, 631]  # RAW, LPD, IPP
        port_available = False
        
        for port in printer_ports:
            if self.check_port(device_info['ip'], port, timeout=2):
                port_available = True
                break
        
        if not port_available:
            result['status'] = 'warning'
            result['details'] = 'æ‰“å°æœºåœ¨çº¿ä½†æ‰“å°æœåŠ¡ç«¯å£ä¸å¯ç”¨'
            result['response_time'] = time.time() - start_time
            return result
        
        result['status'] = 'online'
        result['response_time'] = time.time() - start_time
        result['details'] = 'æ‰“å°æœºè¿è¡Œæ­£å¸¸'
        
        return result
    
    def check_single_device(self, device_name: str, device_info: Dict) -> Tuple[str, Dict]:
        """æ£€æŸ¥å•ä¸ªè®¾å¤‡"""
        device_type = device_info['type']
        
        try:
            if device_type in ['kylin', 'uos', 'server']:
                result = self.check_linux_device(device_name, device_info)
            elif device_type in ['huawei_switch', 'huawei_firewall']:
                result = self.check_network_device(device_name, device_info)
            elif device_type == 'printer':
                result = self.check_printer(device_name, device_info)
            else:
                result = {
                    'name': device_name,
                    'ip': device_info['ip'],
                    'type': device_type,
                    'status': 'error',
                    'details': 'æœªçŸ¥è®¾å¤‡ç±»å‹',
                    'order': device_info.get('order', 999)
                }
        except Exception as e:
            result = {
                'name': device_name,
                'ip': device_info['ip'],
                'type': device_type,
                'status': 'error',
                'details': f'æ£€æŸ¥è¿‡ç¨‹ä¸­å‡ºé”™: {str(e)}',
                'order': device_info.get('order', 999)
            }
        
        return device_name, result
    
    def check_all_devices(self) -> Dict[str, Dict]:
        """å¹¶å‘æ£€æŸ¥æ‰€æœ‰è®¾å¤‡"""
        logger.info("å¼€å§‹è®¾å¤‡å·¡æ£€...")
        
        # è·å–æ’åºåçš„è®¾å¤‡åˆ—è¡¨
        sorted_devices = self.get_sorted_devices()
        logger.info(f"æ€»è®¡è®¾å¤‡æ•°: {len(sorted_devices)}")
        
        results = {}
        
        # ä½¿ç”¨çº¿ç¨‹æ± å¹¶å‘æ£€æŸ¥
        with ThreadPoolExecutor(max_workers=10) as executor:
            future_to_device = {
                executor.submit(self.check_single_device, device_name, device_info): device_name 
                for device_name, device_info in sorted_devices
            }
            
            for future in as_completed(future_to_device):
                device_name = future_to_device[future]
                try:
                    name, result = future.result()
                    results[name] = result
                    logger.info(f"è®¾å¤‡ {name} ({result['ip']}) æ£€æŸ¥å®Œæˆ: {result['status']}")
                except Exception as e:
                    logger.error(f"æ£€æŸ¥è®¾å¤‡ {device_name} æ—¶å‡ºé”™: {e}")
                    results[device_name] = {
                        'name': device_name,
                        'status': 'error',
                        'details': f'æ£€æŸ¥å¤±è´¥: {str(e)}',
                        'order': 999
                    }
        
        return results
    
    def generate_report(self, results: Dict[str, Dict]) -> str:
        """ç”Ÿæˆå·¡æ£€æŠ¥å‘Š"""
        report_lines = []
        report_lines.append("=" * 70)
        report_lines.append(f"è®¾å¤‡å·¡æ£€æŠ¥å‘Š - {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        report_lines.append("=" * 70)
        
        # ç»Ÿè®¡ä¿¡æ¯
        total = len(results)
        online_count = sum(1 for r in results.values() if r.get('status') == 'online')
        offline_count = sum(1 for r in results.values() if r.get('status') == 'offline')
        warning_count = sum(1 for r in results.values() if r.get('status') == 'warning')
        error_count = sum(1 for r in results.values() if r.get('status') == 'error')
        
        report_lines.append(f"\nğŸ“Š ç»Ÿè®¡ä¿¡æ¯:")
        report_lines.append(f"  æ€»è®¡è®¾å¤‡: {total}")
        report_lines.append(f"  åœ¨çº¿è®¾å¤‡: {online_count} âœ…")
        report_lines.append(f"  ç¦»çº¿è®¾å¤‡: {offline_count} âŒ")
        report_lines.append(f"  è­¦å‘Šè®¾å¤‡: {warning_count} âš ï¸")
        report_lines.append(f"  é”™è¯¯è®¾å¤‡: {error_count} â“")
        
        # æŒ‰è®¾å¤‡ç±»å‹åˆ†ç»„æ˜¾ç¤ºï¼Œå¹¶æŒ‰æ’åºé¡ºåº
        device_types = {}
        for device_name, result in results.items():
            dev_type = result.get('type', 'unknown')
            if dev_type not in device_types:
                device_types[dev_type] = []
            device_types[dev_type].append((device_name, result))
        
        # æŒ‰ç…§ç±»å‹æ’åºé¡ºåºæ˜¾ç¤º
        for dev_type in sorted(self.type_order.keys(), key=lambda x: self.type_order.get(x, 99)):
            if dev_type not in device_types:
                continue
                
            # è·å–ç±»å‹æ˜¾ç¤ºåç§°
            type_display_names = {
                'kylin': 'éº’éºŸç³»ç»Ÿ',
                'uos': 'ç»Ÿä¿¡ç³»ç»Ÿ(UOS)',
                'server': 'æœåŠ¡å™¨',
                'huawei_switch': 'åä¸ºäº¤æ¢æœº',
                'huawei_firewall': 'åä¸ºé˜²ç«å¢™',
                'printer': 'æ‰“å°æœº'
            }
            display_name = type_display_names.get(dev_type, dev_type)
            
            # å¯¹è¯¥ç±»å‹ä¸‹çš„è®¾å¤‡æŒ‰orderå­—æ®µæ’åº
            devices = device_types[dev_type]
            devices.sort(key=lambda x: x[1].get('order', 999))
            
            report_lines.append(f"\n{display_name} è®¾å¤‡ ({len(devices)}å°):")
            report_lines.append("-" * 60)
            
            for device_name, result in devices:
                status_icon = {
                    'online': 'âœ…',
                    'offline': 'âŒ',
                    'warning': 'âš ï¸',
                    'error': 'â“',
                    'unknown': 'â”'
                }.get(result['status'], 'â”')
                
                # æ ¼å¼åŒ–å“åº”æ—¶é—´
                response_time = result.get('response_time')
                if response_time:
                    response_str = f"{response_time:.2f}s"
                else:
                    response_str = "N/A"
                
                report_lines.append(
                    f"{status_icon} {device_name:15} | "
                    f"IP: {result.get('ip', 'N/A'):15} | "
                    f"çŠ¶æ€: {result['status']:8} | "
                    f"å“åº”: {response_str:8} | "
                    f"{result.get('details', '')}"
                )
        
        # å¼‚å¸¸è®¾å¤‡æ±‡æ€»ï¼ˆæŒ‰é¡ºåºï¼‰
        abnormal_devices = [
            (name, result) for name, result in results.items() 
            if result.get('status') in ['offline', 'warning', 'error']
        ]
        
        # å¯¹å¼‚å¸¸è®¾å¤‡æŒ‰orderæ’åº
        abnormal_devices.sort(key=lambda x: x[1].get('order', 999))
        
        if abnormal_devices:
            report_lines.append(f"\nğŸš¨ å¼‚å¸¸è®¾å¤‡æ±‡æ€» ({len(abnormal_devices)}å°):")
            report_lines.append("-" * 60)
            for device_name, result in abnormal_devices:
                status_icon = {
                    'offline': 'âŒ',
                    'warning': 'âš ï¸',
                    'error': 'â“'
                }.get(result['status'], 'â”')
                
                report_lines.append(f"{status_icon} {device_name:15} | {result.get('details', 'æœªçŸ¥å¼‚å¸¸')}")
        
        report_lines.append(f"\nğŸ“ æŠ¥å‘Šä¿å­˜ä½ç½®: {self.output_dir}")
        report_lines.append(f"â° å·¡æ£€å®Œæˆæ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        report_lines.append("=" * 70)
        
        return "\n".join(report_lines)

def main():
    """ä¸»å‡½æ•°"""
    # æ·»åŠ å‘½ä»¤è¡Œå‚æ•°è§£æ
    parser = argparse.ArgumentParser(description='å®éªŒå®¤å·¡æ£€ç³»ç»Ÿ')
    parser.add_argument('--output-dir', '-o', type=str, default='./reports',
                       help='æŠ¥å‘Šä¿å­˜ç›®å½•ï¼Œé»˜è®¤ä¸º ./reports')
    parser.add_argument('--quick', '-q', action='store_true',
                       help='å¿«é€Ÿæ¨¡å¼ï¼Œå‡å°‘è¶…æ—¶æ—¶é—´')
    
    args = parser.parse_args()
    
    # åˆå§‹åŒ–æ£€æŸ¥å™¨
    checker = DeviceChecker(output_dir=args.output_dir)
    
    print("=" * 60)
    print("è®¾å¤‡å·¡æ£€ç³»ç»Ÿ v1.1")
    print(f"æŠ¥å‘Šå°†ä¿å­˜åˆ°: {os.path.abspath(args.output_dir)}")
    print("=" * 60)
    print("æ­£åœ¨æ£€æŸ¥è®¾å¤‡çŠ¶æ€...")
    
    # æ‰§è¡Œæ£€æŸ¥
    results = checker.check_all_devices()
    
    # ç”Ÿæˆå¹¶æ˜¾ç¤ºæŠ¥å‘Š
    report = checker.generate_report(results)
    print("\n" + report)
    
    # ä¿å­˜æŠ¥å‘Šåˆ°æ–‡ä»¶
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    filename = os.path.join(args.output_dir, f"device_inspection_report_{timestamp}.txt")
    
    with open(filename, 'w', encoding='utf-8') as f:
        f.write(report)
    
    print(f"\nğŸ“„ è¯¦ç»†æŠ¥å‘Šå·²ä¿å­˜åˆ°: {filename}")
    
    # åŒæ—¶ä¿å­˜ä¸€ä»½HTMLæ ¼å¼çš„æŠ¥å‘Šï¼ˆå¯é€‰ï¼‰
    html_filename = os.path.join(args.output_dir, f"device_inspection_report_{timestamp}.html")     
    save_html_report(results, html_filename, checker.output_dir)
    
    # å¦‚æœæœ‰å¼‚å¸¸è®¾å¤‡ï¼Œè¿”å›éé›¶é€€å‡ºç 
    abnormal_count = sum(1 for r in results.values() 
                        if r.get('status') in ['offline', 'warning', 'error'])
    
    if abnormal_count > 0:
        print(f"âš ï¸  è­¦å‘Š: å‘ç° {abnormal_count} å°å¼‚å¸¸è®¾å¤‡")
        return 1
    
    print("âœ… æ‰€æœ‰è®¾å¤‡æ£€æŸ¥æ­£å¸¸ï¼")
    return 0

def save_html_report(results: Dict[str, Dict], filename: str, output_dir: str):
    """ä¿å­˜HTMLæ ¼å¼çš„æŠ¥å‘Šï¼ˆå¯é€‰åŠŸèƒ½ï¼‰"""
    try:
        # è·å–å½“å‰æ—¶é—´
        current_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        
        # ç»Ÿè®¡ä¿¡æ¯
        total = len(results)
        online_count = sum(1 for r in results.values() if r.get('status') == 'online')
        offline_count = sum(1 for r in results.values() if r.get('status') == 'offline')
        warning_count = sum(1 for r in results.values() if r.get('status') == 'warning')
        error_count = sum(1 for r in results.values() if r.get('status') == 'error')
        
        # ç”ŸæˆHTMLå†…å®¹
        html_content = f"""<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®éªŒå®¤å·¡æ£€æŠ¥å‘Š - {current_time}</title>
    <style>
        body {{ font-family: 'Microsoft YaHei', Arial, sans-serif; margin: 20px; }}
        .header {{ background-color: #f0f0f0; padding: 20px; border-radius: 5px; }}
        .stats {{ background-color: #e9ecef; padding: 15px; border-radius: 5px; margin: 20px 0; }}
        .device-table {{ width: 100%; border-collapse: collapse; margin: 20px 0; }}
        .device-table th, .device-table td {{ border: 1px solid #ddd; padding: 8px; text-align: left; }}
        .device-table th {{ background-color: #4CAF50; color: white; }}
        .status-online {{ color: green; font-weight: bold; }}
        .status-offline {{ color: red; font-weight: bold; }}
        .status-warning {{ color: orange; font-weight: bold; }}
        .status-error {{ color: purple; font-weight: bold; }}
        .summary {{ margin-top: 30px; padding: 15px; background-color: #f8d7da; border-radius: 5px; }}
    </style>
</head>
<body>
    <div class="header">
        <h1>å®éªŒå®¤å·¡æ£€æŠ¥å‘Š</h1>
        <p>ç”Ÿæˆæ—¶é—´: {current_time}</p>
        <p>æŠ¥å‘Šä½ç½®: {output_dir}</p>
    </div>
    
    <div class="stats">
        <h2>ç»Ÿè®¡ä¿¡æ¯</h2>
        <p>æ€»è®¡è®¾å¤‡: {total}</p>
        <p>åœ¨çº¿è®¾å¤‡: <span class="status-online">{online_count}</span></p>
        <p>ç¦»çº¿è®¾å¤‡: <span class="status-offline">{offline_count}</span></p>
        <p>è­¦å‘Šè®¾å¤‡: <span class="status-warning">{warning_count}</span></p>
        <p>é”™è¯¯è®¾å¤‡: <span class="status-error">{error_count}</span></p>
    </div>
    
    <h2>è®¾å¤‡è¯¦ç»†çŠ¶æ€</h2>
    <table class="device-table">
        <tr>
            <th>è®¾å¤‡åç§°</th>
            <th>IPåœ°å€</th>
            <th>è®¾å¤‡ç±»å‹</th>
            <th>çŠ¶æ€</th>
            <th>å“åº”æ—¶é—´</th>
            <th>è¯¦ç»†ä¿¡æ¯</th>
        </tr>
"""
        
        # æŒ‰é¡ºåºæ·»åŠ è®¾å¤‡è¡Œ
        sorted_results = sorted(results.items(), key=lambda x: x[1].get('order', 999))
        
        for device_name, result in sorted_results:
            status_class = f"status-{result.get('status', 'unknown')}"
            response_time = result.get('response_time')
            response_str = f"{response_time:.2f}s" if response_time else "N/A"
            
            html_content += f"""
        <tr>
            <td>{device_name}</td>
            <td>{result.get('ip', 'N/A')}</td>
            <td>{result.get('type', 'unknown')}</td>
            <td class="{status_class}">{result.get('status', 'unknown')}</td>
            <td>{response_str}</td>
            <td>{result.get('details', '')}</td>
        </tr>
"""
        
        # å¼‚å¸¸è®¾å¤‡æ±‡æ€»
        abnormal_devices = [(name, r) for name, r in results.items() 
                           if r.get('status') in ['offline', 'warning', 'error']]
        
        if abnormal_devices:
            html_content += f"""
    </table>
    
    <div class="summary">
        <h2>å¼‚å¸¸è®¾å¤‡æ±‡æ€» ({len(abnormal_devices)}å°)</h2>
        <ul>
"""
            for device_name, result in abnormal_devices:
                html_content += f'            <li>{device_name}: {result.get("details", "æœªçŸ¥å¼‚å¸¸")}</li>\n'
            
            html_content += "        </ul>\n    </div>\n"
        
        html_content += """
</body>
</html>
"""
        
        # å†™å…¥æ–‡ä»¶
        with open(filename, 'w', encoding='utf-8') as f:
            f.write(html_content)
        
        print(f"ğŸŒ HTMLæŠ¥å‘Šå·²ä¿å­˜åˆ°: {filename}")
        
    except Exception as e:
        print(f"ç”ŸæˆHTMLæŠ¥å‘Šå¤±è´¥: {e}")

if __name__ == "__main__":
    exit_code = main()
    exit(exit_code)